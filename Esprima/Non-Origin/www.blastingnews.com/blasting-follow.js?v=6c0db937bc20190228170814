var show_modal;
var chiSeguireReload;
var is_rating = false;
var partecipa = false;
$(document).ready(function () {
var that_button;
  show_modal = function (element, opzType, jsonObj, customSlogan, redirect_url, callback_show_modal) {
    if(typeof customSlogan === "undefined") {
      var customSlogan = false;
    }
    if(typeof redirect_url === "undefined") {
      var redirect_url = false;
    }
    if(typeof callback_show_modal === "undefined") {
      var callback_show_modal = false;
    }
    if ($(".pol-cookie-accept").length > 0) { /*to auto-accept cookie policy */ $('.pol-cookie-accept').trigger('click'); }
    var FirstModalDisplay = 0;
    var user_id_param = new String();
    var is_blaster_page = element.hasClass('blasterpageclass') ? true : false;
    var is_invitation = element.hasClass('inv') ? true : false;
    var is_invitation2 = element.hasClass('inv2') ? true : false;
    var is_share = element.hasClass('share') ? true : false;
    var notify_id = element.hasClass('notifica-no-logged-modal-login') ? element.attr('id') : false;
    var partecipa = element.hasClass('partecipa') ? true : false;
    that_button = element;
    
    
    is_rating = typeof element.attr('data-rate') !== "undefined" ? true : false;

    var is_invitation3 = element.hasClass('inv3') ? true : false;
    var is_registration_right = element.hasClass('registration-right') ? true : false;
    var param_type_flow = false;
    if (typeof type_flow !== "undefined") {
      param_type_flow = type_flow;
    }
    var is_skin = false;
    var is_follow_flag = element.hasClass('follow') ? true : false;
    if (param_type_flow !== false && param_type_flow == 1 && is_rating != true && is_blaster_page != true && is_invitation != true && is_invitation2 != true && is_follow_flag != true) {
      is_skin = true;
    }

    $("#follow-invitation").remove();
    if (flagLogged == true) {
      if (flagCountry) {
        user_id_param = getUserId(element);
        var action = getAction(element);
        if (action == false) {
          return false;
        }

        var status = getStatusByAction(action);

        activateLoaderoOnButton(action);
        
        $.ajax({
          type: 'POST',
          url: '/app/follow/',
          data: {
            user_id: user_id_param,
            action: action,
          },
          success: function (result) {
            if (result == true) {
              var newStatus = getNewStatusByOldStatus(status);
              element.removeClass(status);
              element.addClass(newStatus);

              if (is_blaster_page == true) {
                var list_f = new Array();
                var indexFollow = 0;
                var Followed = null;
                var j = 0;
                for (var i = 1; i <= 4; i++) {
                  var select_list = $('.l_follow' + i).filter('.not-following');
                  var user_idf = getUserId(select_list);
                  if (user_idf !== false) {
                    list_f[j] = user_idf;
                    j++;
                  }
                  else {
                    var temp = $('.l_follow' + i).filter('.following');
                    Followed = getUserIdChiSeguire(temp);
                    indexFollow = i;
                  }
                }

                getNextToFollow(blnf_uid, list_f, indexFollow, Followed);
              }
            } else {
              if (is_blaster_page == true) {
                if (typeof chiSeguireReload == 'function') {
                  chiSeguireReload();
                }
              }
            }
             deActivateLoaderoOnButton();
          }
        });
      } else {

        var blaster_name = element.prev(".iaf").html();

        if ($('.country-modal-error').length == 0) {
          $.ajax({
            type: 'POST',
            url: '/app/get_modal_login_follow/',
            data: {type: 'country-error'},
            success: function (html) {
              $("body").append(html);
              show_overlay_no_country(blaster_name);
            }
          });
        } else {
          show_overlay_no_country(blaster_name);
        }
      }
    } else {

      var blaster_name = element.prev(".iaf").html();
      if(element.hasClass('partecipa')) {
        blaster_name = element.data("socialrefname");
      }

      var user_id_param = getUserId(element);
      var news_condivi = null;

      if (is_share) {
        news_condivi = element.attr('data-news');
      }

      shown_popupfanpage = true; //inibisco l'apertura del popup fanpage
      $('#selectedYou').hide();

      if ($('#loggin-follow-modal').length == 0) {
        $("body").append("<div id='loggin-follow-modal' class='modal'><div class='overlay-follow'><div class='modal-dialog'><div id='follow-loader'><div class='box-loader'></div></div></div></div></div>");
        FirstModalDisplay = 1;
      }
      ///
      if (FirstModalDisplay === 1 || opzType == "NoEmail" || opzType == "FB-COMMENTS-REG" || opzType == "FB-COMMENTS-REG-mobile" || opzType == "LANDING-SOCIAL-LOGIN") {
        if (opzType == "NoEmail") {
          $.ajax({
            type: 'POST',
            url: '/app/get_modal_login_follow/',
            data: {type: 'FB_noemailgiven'},
            success: function (html) {
              closeLatestModal();
              $("#loggin-follow-modal .modal-dialog").html(html);
              ////
              $("#contact_nome-follow").attr("placeholder", jsonObj.name);
              $("#contact_cognome-follow").attr("placeholder", jsonObj.surname);
              $("#hiddenAccessToken").val(jsonObj.access_token);

              ////
              $("body").append($(".country-modal-error"));
              $("body").append($(".social-modal-error"));

              if($.isFunction(callback_show_modal)){
                callback_show_modal();
              }
              show_overlay_follow_init(is_invitation, user_id_param, blaster_name, is_invitation2, is_invitation3, news_condivi, is_rating, is_registration_right, is_skin, notify_id, partecipa, customSlogan, redirect_url);
            }
          });
        } else if (opzType == "FB-COMMENTS-REG" || opzType == "FB-COMMENTS-REG-mobile") {
          $.ajax({
            type: 'POST',
            url: '/app/get_modal_login_follow/',
            data: {type: 'all'},
            success: function (html) {
              $("#loggin-follow-modal .modal-dialog").html(html);

              if (opzType == "FB-COMMENTS-REG-mobile") {
                $("#login-facebook-follow").hide();
                //$("#login-google-plus-follow").hide();
                $("#login-your-mail-follow-mobile").hide();
                $(".cancel-follow").addClass("pull-right");
                $("#form-register-follow").show();
                $(".back-follow").show();
                $(".accedi-mobile").hide();
                $('body').removeClass('fixed');
                $("#loggin-follow-modal").addClass("overlay-follow-mobile");
              }
              show_overlay_follow_init(is_invitation, user_id_param, blaster_name, is_invitation2, is_invitation3, news_condivi, is_rating, is_registration_right, is_skin, notify_id, partecipa, customSlogan, redirect_url);
            }
          });
          
        } else if (opzType == "LANDING-SOCIAL-LOGIN") {  
          $.ajax({
            type: 'POST',
            url: '/app/get_modal_login_follow/',
            data: {type: 'all'},
            success: function (html) {
              $("#loggin-follow-modal .modal-dialog").html(html);
              $("body").append($(".country-modal-error"));
              $("body").append($(".social-modal-error"));
              show_overlay_follow_init(is_invitation, user_id_param, blaster_name, is_invitation2, is_invitation3, news_condivi, is_rating, is_registration_right, is_skin, notify_id, partecipa, customSlogan, redirect_url);
              $(".slogan-follow").html(landing_16);
              $("#login-your-mail-follow").remove();
              $("#login-your-mail-follow-mobile").remove();
              $("#follow-first .modal-header button.close").remove();
              $(".overlay-follow").addClass("overlay-follow-dont-close");
              $(".overlay-follow-dont-close").removeClass("overlay-follow");
              if($(".cancel-follow").length > 0) {
                $(".cancel-follow").remove();
              }
            }
          });
            
        } else {
          $.ajax({
            type: 'POST',
            url: '/app/get_modal_login_follow/',
            data: {type: 'all'},
            success: function (html) {
              $("#loggin-follow-modal .modal-dialog").html(html);
              $("body").append($(".country-modal-error"));
              $("body").append($(".social-modal-error"));

              show_overlay_follow_init(is_invitation, user_id_param, blaster_name, is_invitation2, is_invitation3, news_condivi, is_rating, is_registration_right, is_skin, notify_id, partecipa, customSlogan, redirect_url);
            }
          });
        }
      }
      else {
        show_overlay_follow_init(is_invitation, user_id_param, blaster_name, is_invitation2, is_invitation3, news_condivi, is_rating, is_registration_right, is_skin, notify_id, partecipa, customSlogan, redirect_url);
      }
    }

  }

  $(document).on("click", ".follow", function () {
    show_modal($(this));
  });

  $(document).on("click", ".modal-login", function() {
    if ( $( this ).hasClass( "registration-right" ) ) {
        return;
    } else {
        show_modal($(this));
    }
  });

  $(document).on("click", ".not-following", function () {
    $(this).addClass('touch');
  });
  $(document).on("click", ".following", function () {
    $(this).removeClass('touch');
  });
  $(document).on("click", ".close-follow-overlay", function () {
    closeOverlay_follow();
  });
  $(document).on("click", ".overlay-follow", function () {
    closeOverlay_follow();
  });
  $(document).on("click", ".cancel-follow", function () {
    closeOverlay_follow();
  });
  $(document).on("click", "#a-register-follow", function () {
    $("#login-content-follow").hide();
    $(".register-follow").show();
    $(".accedi-desk").show();
    if (!$("#slogan-follow-invitation").is(":visible")) {
      $(".slogan-follow").show();
    }
  });
  $(document).on("click", "#a-register-follow-mobile", function () {
    $("#login-content-follow").hide();
    $(".back-follow").hide();
    $(".register-follow").show();
    $(".cancel-follow").show();
    $(".accedi-mobile").show();
    $("#loggin-follow-modal").removeClass("overlay-follow-mobile");
    $(".cancel-follow").removeClass("pull-right");
    $("#form-register-follow").hide();
    $("#login-facebook-follow").show();
    //$("#login-google-plus-follow").show();
    $("#login-your-mail-follow-mobile").show();
  });
  $(document).on("click", "#login-your-mail-follow-mobile", function () {
    $("#login-facebook-follow").hide();
    //$("#login-google-plus-follow").hide();
    $("#login-your-mail-follow-mobile").hide();
    $(".cancel-follow").addClass("pull-right");
    $("#form-register-follow").show();
    $(".back-follow").show();
    $(".accedi-mobile").hide();
    $('body').removeClass('fixed');
    $("#loggin-follow-modal").addClass("overlay-follow-mobile");
  });
  $(document).on("click", ".back-follow", function () {
    $("#login-content-follow").hide();
    $(".register-follow").show();
    $("#login-facebook-follow").show();
    //$("#login-google-plus-follow").show();
    $("#login-your-mail-follow-mobile").show();
    $(".cancel-follow").show();
    $("#form-register-follow").hide();
    $(".back-follow").hide();
    $(".accedi-mobile").show();
    $(".cancel-follow").removeClass("pull-right");
    $('body').addClass('fixed');
    $("#loggin-follow-modal").removeClass("overlay-follow-mobile");
  });
  $(document).on("click", ".accedi-mobile", function () {
    $(".register-follow").hide();
    $(".back-follow").show();
    $(".accedi-mobile").hide();
    $(".cancel-follow").show();
    $(".cancel-follow").addClass("pull-right");
    $("#login-content-follow").show();
    $("#loggin-follow-modal").addClass("overlay-follow-mobile");
    $("#form-login-follow").show();
    $("#form-recover-password-follow").hide();
  });
  $(document).on("click", ".accedi-desk", function () {
    $(".register-follow").hide();
    $(".seleziona-azione").hide();
    $(".accedi-desk").hide();
    $("#login-content-follow").show();
    $(".slogan-follow").hide();
  });
  $(document).on("click", ".modal-dialog", function (event) {
    event.stopPropagation();
  });
  $(document).on("click", ".iscriviti", function () {
    $(".seleziona-azione").hide();
    $(".register-follow").show();
    $(".modal-footer p").show();
    $("#loggin-follow-modal").addClass("overlay-follow-mobile");
  });
  
  
 
  
//$(".annulla").on("click", function() {
//closeOverlay_follow();
//});
function activateLoaderoOnButton(action){
    that_button.attr("disabled", "disabled");
    var width_before_click = that_button.outerWidth();
    that_button.addClass('loader');
    that_button.css('min-width', width_before_click);
}
function deActivateLoaderoOnButton(){
    that_button.removeAttr("disabled");
    that_button.removeClass('loader');
    that_button.css('min-width',0);
}

  function getUserIdChiSeguire(obj) {

    var className = obj.siblings('.iaf').attr('class');
    if (typeof className !== 'undefined') {
      var classArray = className.split(" ");
      return classArray[classArray.length - 1];
    }
    else {
      return false;
    }
  }
  function getUserId(obj) {

    var className = obj.siblings('.iaf').attr('class');
    if (typeof className !== 'undefined') {
      var classArray = className.split(" ");
      return classArray[classArray.length - 1];
    }
    else {
      return false;
    }
  }

  function getAction(obj) {
    var statusActionAssoc = getStatusActionAssoc();
    for (var key in statusActionAssoc) {
      if (obj.hasClass(key) == true) {
        return statusActionAssoc[key];
      }
    }
    return false;
  }

  function getStatusByAction(action) {
    var statusActionAssoc = getStatusActionAssoc();
    for (var key in statusActionAssoc) {
      if (statusActionAssoc[key] == action) {
        return key;
      }
    }
    return false;
  }

  function getNewStatusByOldStatus(status) {
    var statusChange = new Array();
    statusChange['following'] = 'not-following';
    statusChange['not-following'] = 'following';
    if (typeof statusChange[status] !== 'undefined') {
      return statusChange[status];
    }
    return false;
  }

  function getStatusActionAssoc() {
    var statusActionAssoc = new Array();
    statusActionAssoc['following'] = 'defollow';
    statusActionAssoc['not-following'] = 'follow';
    return statusActionAssoc;
  }

}
);
function closeOverlay_follow() {
  $("#loggin-follow-modal").hide();
  if (!$(".overlay-follow").hasClass("tracking-facebook")) {
    $('body').removeClass('fixed');
    $('body').css('padding-right', '0');
  }
  $('#header').removeClass('modal-aperta-fixed');
  $('#header').css('padding-right', '0');
  $('#breaking-news').removeClass('modal-aperta-fixed');
  //$('#menu-mobile-trigger').css("opacity", "1");
  $("#form-register-follow").hide();
  $(".cancel-follow").removeClass("pull-right");
  $("#loggin-follow-modal").removeClass("overlay-follow-mobile");
  $(".follow").removeClass('touch');
  $(".slogan-follow").show();
  $("#slogan-follow-invitation").hide();
  $(".modal-header-lbl-1").html(message_60);
  $(".modal-header-lbl-2").html(message_61);
  if (typeof type_flow !== "undefined") {
    type_flow = false;
  }
}

function show_overlay_follow_init(is_invitation, user_id, blaster_name, is_invitation2, is_invitation3, condividi, is_rating, is_registration_right, is_skin, notify_id, partecipa, customSlogan, redirect_url) {
  
  if(typeof customSlogan === "undefined") {
    var customSlogan = false;
  }
  
  if(typeof redirect_url === "undefined") {
    var redirect_url = false;
  }
  
  $(".blasting-follow-overlay div, .accedi-sx, #login-your-mail-follow, #login-your-mail-follow-mobile, .modal-footer div").removeAttr('style');
  
  $('#loggin-follow-modal').show();
  $('body').addClass('fixed');
  $('body').css('padding-right', scrollBarWidth);
  $('#header').addClass('modal-aperta-fixed');
  $('#header').css('padding-right', scrollBarWidth);
  $('#breaking-news').addClass('modal-aperta-fixed');
  //$('#menu-mobile-trigger').css("opacity", "0");

  if ((typeof email_conf_sent == 'undefined' || email_conf_sent === false) && unconfirmed_fb_user === false) {

    document.ontouchmove = function (e) {
      var target = e.target;
      if (target.getAttribute('class') == "overlay-follow" || target.getAttribute('class') == "form-control") {
        e.preventDefault();
      }
      return;
    };

    $("#follow-no-active").hide();
    $("#follow-first").show();
    ///
    $("#fb-noemail").show();
    ///
    $("#id_following").val(user_id);
    if (is_invitation) {
      $(".slogan-follow").hide();
      $("#slogan-follow-invitation").show();
      $("#form-register-follow").append("<input id='follow-invitation' type='hidden' name='follow-invitation' value='1'>");
      $(".modal-header-lbl-1").html(message_62);
      $(".modal-header-lbl-2").html(message_63);
    }
    if (is_invitation2) {
      $(".slogan-follow").hide();
      $("#slogan-follow-invitation").show();
      $("#slogan-follow-invitation").html(message_68);
      $(".modal-header-lbl-1").html(message_67);
      $(".modal-header-lbl-2").html(message_69_mobile);
    }
    
    if (condividi != null) {
      $("#form-register-follow").append("<input id='share-news-to' type='hidden' name='share-news-to' value='" + condividi + "'>");
    }

    if (is_invitation3) {
      $(".slogan-follow").hide();
      $("#slogan-follow-invitation").show();
      $("#slogan-follow-invitation").html(message_75_inv3);
      $(".modal-header-lbl-1").html(message_67);
      $(".modal-header-lbl-2").html(message_75_inv3);

    }
    if (user_id == false) {//allora non stiamo facendo un click sul follow ma stiamo nel caso dell'accrocco
      $(".slogan-follow").html(message_70);
      $(".modal-header-lbl-2").html(message_72_mobile);
    } else {
      $(".slogan-follow").html(message_71);
    }

    if (condividi != null) {
      $(".slogan-follow").show();
      $(".slogan-follow").html(message_81_share);
      $(".modal-header-lbl-2").html(message_81_share);
    }
    if (is_rating) {
      $(".slogan-follow").show();
      $(".slogan-follow").html(message_77_rating);
      $(".modal-header-lbl-1").html(message_76_rating);
      $(".modal-header-lbl-2").html(message_76_rating);
    }
    if (partecipa) {
      $(".slogan-follow").show();
      $(".slogan-follow").html(message_86_direttelive);
      $(".modal-header-lbl-1").html(message_85_direttelive);
      $(".modal-header-lbl-2").html(message_85_direttelive);
    }


    if (notify_id !== false) {
      $(".slogan-follow").show();
      message = notify_id === 'notifica-no-logged-1' ? message_82_notify_1 : (notify_id === 'notifica-no-logged-2' ? message_83_notify_2 : (notify_id === 'notifica-no-logged-3' ? message_84_notify_3 : message_84_notify_0));
      $(".slogan-follow").html(message);
      $(".modal-header-lbl-2").html(message);
    }
    if (is_registration_right) {
      $(".slogan-follow").show();
      $(".slogan-follow").html("");
    }
    if (is_skin) {
      $(".slogan-follow").show();
      $(".slogan-follow").html("");
    }

  } else {
    $("#form-register-follow").hide();
    $("#follow-no-active").show();
    $("#follow-first").hide();
    $("#fb-noemail").hide();

  }
  
  if(customSlogan !== false) {
    $(".slogan-follow").html(customSlogan);
  }
  
  if(redirect_url !== false) {
    redirect_url_login = redirect_url;
  }

  $('.blaster-following-name').html(blaster_name);

  //Inizializzo l'sdk a richiesta
  Blasting.FacebookSDK.init();
}

function show_overlay_no_country(blaster_name) {
  $('.blaster-following-name').html(blaster_name);
  $('.country-modal-error').modal('show');
  $('body').addClass('fixed');
}
