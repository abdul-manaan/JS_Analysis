var w = 800;
var h = 750;
var l = Math.floor((screen.width - w) / 2);
var t = Math.floor((screen.height - h) / 2);
var was_active_button = false;
var contacts;
var contact_no_policy_with_label;
var myWin;
var sharedNewsFromUser = Array();
var sharedVideoFromUser = Array();
var return_child_provider = false;
var shared_value_before_click_button = false;
var can_share_value_before_click = false;
var modale_condividi;


var has_content_box_form_active = 0;

function clickPopup(prov) {

  $('#chk-flag-policy-share').prop('checked', false);
  $("#alert-success-basso").hide();

  var provider = $(prov).attr("id");

  if (flagLogged) {
    activateButton(provider);
    if (provider !== "Altro") {
      hideContentFormAltro();

      if (itemtype == T_NEWS) {
        myWin = window.open("/app/invite_contact/?service=share_news&p=" + provider, "", "'location=no,addressbar=0,width=" + w + ",height=" + h + ",top=" + t + ",left=" + l);
      } else {
        myWin = window.open("/app/invite_contact/?service=share_video&p=" + provider, "", "'location=no,addressbar=0,width=" + w + ",height=" + h + ",top=" + t + ",left=" + l);
      }


    } else {

      var that = $(prov);
      if (that.hasClass('active')) {

        if (that.hasClass('0')) {
          hideContentFormAltro();
          that.removeClass('0');
          that.removeClass('active');
          if (was_active_button) {
            $('.content-box-form').addClass('content-box-form-active');
          } else {
            was_active_button = $('.content-box-form').hasClass('content-box-form-active');
            $('.content-box-form').removeClass('content-box-form-active');
          }
        } else {
          showContentFormAltro();
          that.addClass('0');
        }

      } else {
        showContentFormAltro();
      }

    }
    if (provider_active_users == "Altro" || provider_active_users != provider) {
      //showContentFormAltro();
    } else {
      hideContentFormAltro();
      //$(".content-form").removeClass("hide");
    }
    $(".content-thanks").hide();
  } else {
    //$("#login-button").trigger("click");
    $("#menu-mobile-trigger").trigger("click");
    $("#login-button-mobile").trigger("click");
  }
}

var next_provider_n = 0;
var next_provider_arr = null;


function clickToButton(button_clicked) {

  var btn_share_response_mode = null;
  var btn_share_response_message = null;

  var modale_condividi = new modaleShareClickButton();

  $('#alert-success-basso').hide();
  //$(".alert").fadeOut();
  $("#error-generic").fadeOut();

  var res_add_contact = add_contacts_ajax();

  /* se non ho check della privacy non faccio nulla*/
  if (res_add_contact && chebox_policy_share.prop('checked')) {

    var news_id = $(button_clicked).attr("data-news");
    var link = $(".share." + news_id + ".opened");
    var link_to_share = new sharelink(link[0]);

    $.ajax({
      type: 'GET',
      url: '/app/condividi/',
      data: {
        action: 'share',
        news_id: news_id,
        itemtype: itemtype,
        site: currentSite
      },
      success: function (response) {
        if (response && response.response_data)
        {
          btn_share_response_mode = response.response_code;
          btn_share_response_message = response.response_data.message;

          modale_condividi.hideMsgWarningCentro();

          switch (btn_share_response_mode)
          {
            case 'MODE_PRESSED_ALREADYSHARED':
            case 'MODE_PRESSED_LIMIT_REACHED':

              modale_condividi.showCanNotShare();

              break;
            case 'MODE_PRESSED_SHARED':
              pushItem(link_to_share.getNewsId(), itemtype);
              link_to_share.shared();

              //condivisione la prima volta
              modale_condividi.showShared();

              break;
            case 'MODE_PRESSED_ZERO_CONTACTS':
            case 'MODE_PRESSED_ZERO_CONTACTS_POLICED':
            default:
              console.log('ERROR ' + btn_share_response_message);
              break;
          }

          contacts = response.response_data.contacts;
          
          if (response.response_data.count_shared_news) {
            $('#' + news_id).siblings('.count-box').children('.count').html(response.response_data.count_shared_news);
          }

          modale_condividi.hideButton();
          bshare_first_import = null;


        }
      }
    });

  }

}

function clickNo() {

  $(".alert").fadeOut();
  $("#error-generic").fadeOut();
  if (next_provider_arr !== null) {
    if (typeof next_provider_arr[next_provider_n] !== "undefined") {
      $("#next-provider-img").removeAttr("class").addClass("logo-client").addClass(next_provider_arr[next_provider_n].provider_name.toLowerCase());
      $(".thanks-provider").attr('data-providername', next_provider_arr[next_provider_n].provider_name).html(next_provider_arr[next_provider_n].label);
      activateButton(next_provider_arr[next_provider_n].provider_name);
      $(".content-thanks").show();

      next_provider_n++;
    } else {
      $(".content-thanks").hide();
      deActivateAllButtons();

    }
    hideContentFormAltro();
  }

}
function clickSi() {

  if (next_provider_arr !== null) {
    $("#" + next_provider_arr[next_provider_n - 1].provider_name).trigger("click");
  }

}

function add_contacts_ajax() {
  provider = $('.clickPopup.active').attr("id");
  var res = true;

  if (provider == 'Altro' && $(".invito-user-altro").val() == '') {
    showMessage(share_news_message_message_email_field_empty);
    res = false;
  } else {

    $.ajax({
      type: 'POST',
      dataType: "json",
      url: '/app/add_invite_contacts/',
      async: false,
      data: {
        contacts: $("#form-inviti-altro").serializeArray(),
        flag_policy_send: $('#chk-flag-policy-share').is(':checked'),
        policy_flag: $('#chk-flag-policy-share').is(':checked'),
        action: 'import',
        contacts_for_page: 2,
      },
      success: function (result) {
        if (result.status == 200) {

          if (typeof result.response_data.next_providers[next_provider_n] !== "undefined") {
            if (provider == 'Altro')
              next_provider_n = 0;

            next_provider_arr = result.response_data.next_providers;
            $("#next-provider-img").removeAttr("class").addClass("logo-client").addClass(result.response_data.next_providers[next_provider_n].provider_name.toLowerCase());
            $(".thanks-provider").attr('data-providername', result.response_data.next_providers[next_provider_n].provider_name).html(result.response_data.next_providers[next_provider_n].label);
            activateButton(result.response_data.next_providers[next_provider_n].provider_name);

            hideContentFormAltro();
            next_provider_n++;
          }

          if (provider == "Altro") {
            last_provider_imported_name = "Altro";
            $('#email-altro').val('');
            $(".invito-user-altro").val("");

            hideContentFormAltro();
            $('#Altro').removeClass("0").removeClass("active");
          } else {

            $('.content-box-form').removeClass('content-box-form-active');
          }
          if (typeof result.response_data.count_friends !== "undefined" && result.response_data.count_friends > 0 && typeof result.response_data.friends_html !== "undefined") {
            $('#box-content-amici-trovati').html(result.response_data.friends_html);
            $('#box-content-amici-trovati').show();
          }
          has_content_box_form_active = 0;

          if (provider != "Altro") {
            $("#" + last_provider_imported_name).siblings('.aggiorna').addClass('aggiorna-active');
          }

        } else if (result.status == "Error") {
          showMessage(result.message);
          $('.content-box-form').addClass('content-box-form-active');
          res = false;

        } else {

        }
      },
      error: function () {
        showMessage("connection error");
        res = false;
      }
    });
  }
  return res;
}

function activateButton(id) {
  $(".clickPopup").removeClass("active");
  $("#" + id).addClass("active");
}

function deActivateAllButtons() {
  $(".clickPopup").removeClass("active");
}

function addButtonCheck(id) {
  $("#" + id + " > .spunta").addClass('spunta-active');
}

function getChildValue(data) {
  if (data != false && data.id != "") {
    last_provider_imported_name = data.provider_name;
    last_provider_imported_label = data.label;

    var modale_condividi = new modaleShareClickButton();

    if (data.count_imported > 0) {

      has_content_box_form_active = 1;
      addButtonCheck(last_provider_imported_name);
      next_provider_n = 0;

      $('#chk-flag-policy-share').prop('checked', false);
      modale_condividi.manageMessageNewContactsImported();

      $('.content-box-form').addClass('content-box-form-active');
    }
    else
    {

      modale_condividi.manageMessageNoNewContactsImported();

    }

    $.ajax({
      type: 'GET',
      dataType: "json",
      url: '/app/condividi/',
      async: false,
      data: {action: "unset_import"},
//          success: function (result) {
//
//          }
    });


    return_child_provider = data;
  }
}

function showContentFormAltro() {
  $(".content-form-altro").removeClass("hide");
  $("#txt-comma").removeClass("hide");
  $("#form-inviti-altro").removeClass("hide");
  $('.content-box-form').addClass('content-box-form-active');
}

function hideContentFormAltro() {
  $(".content-form-altro").addClass("hide");
  $("#txt-comma").addClass("hide");
  $("#form-inviti-altro").addClass("hide");
  if (has_content_box_form_active) {
    $('.content-box-form').addClass('content-box-form-active');
  } else {
    $('.content-box-form').removeClass('content-box-form-active');
  }
}

/*gli errori*/
function showMessage(text) {
  err = $("#error-generic");
  err.html(text);
  err.show();
  setTimeout(function () {
    err.fadeOut();
  }, 10000);
}

/*i warning e i success (i messaggi sono già in pagina)*/
function showAlert(id) {
  alert = $("#" + id);
  box = alert.parent();
  var content = alert.html();

  if (content.length != 0) {

    box.show();
    alert.show();
    setTimeout(function () {
      box.fadeOut();
      box.children("span").hide();
    }, 10000);
  }
}

var start = true;

function email_validator() {
  if (start) {
    start = false;
    $.ajax({
      type: 'POST',
      dataType: "json",
      url: '/app/emails_validator/',
      data: {
        string: $(".invito-user-altro").val(),
      },
      success: function (result) {
        if (result.status == 200) {
          $(".invito-user-altro").val(result.response_data.join(", "));
        } else if (result.status == "Error") {
          showMessage(result.message);
        } else {
          console.log(result);
        }
      },
      error: function () {
        showMessage("connection error");
      }
    });
    setTimeout(function () {
      start = true;
    }, 500);
  }
}

modaleShareClickButton = function () {
  this.titolo = $('#title-provider');
  this.msgVerdeAlto = $('#msgSuccessAlto');
  this.msgWarningAlto = $('#msgWarningAlto');
  this.msgVerdeCentro = $('#msgSuccess');
  this.msgWarningCentro = $('#msgWarning');
  this.msgCarrello = $('#msgimportedok');
  this.carrello = $(".content-thanks");
  this.button = $('.content-box-form');

  this.showTitolo = function () {
    this.titolo.show();
  }

  this.hideTitolo = function () {
    this.titolo.hide();
  }
  this.setmsgVerdeAlto = function (message) {
    this.msgVerdeAlto.html(message);
  }
  this.showmsgVerdeAlto = function () {
    this.msgVerdeAlto.show();
    this.msgVerdeAlto.parent().show();
  }
  this.setmsgVerdeCentro = function (message) {
    this.msgVerdeCentro.html(message);
  }
  this.showmsgVerdeCentro = function () {
    this.msgVerdeCentro.show();
    this.msgVerdeCentro.parent().show();
  }
  this.hidemsgVerdeAlto = function () {
    this.msgVerdeAlto.hide();
  }
  this.setmsgCarrello = function (message) {
    this.msgCarrello.html(message);
  }
  this.showmsgCarrello = function () {
    this.msgCarrello.show();
  }
  this.hidemsgCarrello = function () {
    this.msgCarrello.hide();
  }
  this.showCarrello = function () {
    this.carrello.show();
    //check integrity buttons
    activateButton($('.thanks-provider').attr('data-providername'));
  }
  this.hideCarrello = function () {
    this.carrello.hide();
  }

  this.setWarningAlto = function (message) {
    this.msgWarningAlto.html(message);
  }
  this.showMsgWarningAlto = function () {
    this.msgWarningAlto.show();
    this.msgWarningAlto.parent().show();
  }
  this.hideMsgWarningAlto = function () {
    this.msgWarningAlto.hide();
    this.msgWarningAlto.parent().hide();
  }
  this.setWarningCentro = function (message) {
    this.msgWarningCentro.html(message);
  }
  this.showMsgWarningCentro = function () {
    this.msgWarningCentro.show();
    this.msgWarningCentro.parent().show();
  }
  this.hideMsgWarningCentro = function () {
    this.msgWarningCentro.hide();
    this.msgWarningCentro.parent().hide();
  }
  this.showButton = function () {
    this.button.addClass('content-box-form-active');
  }
  this.hideButton = function () {
    this.button.removeClass('content-box-form-active');
  }

  this.showShared = function () {

    if (bshare_first_import) {
      //condivisione e prima importazione

      //this.hidemsgVerdeAlto();
      this.setmsgCarrello(message_gettext('share_news_message_invited_contacts2', itemtype));
      this.showmsgCarrello();
      this.showCarrello();
    }
    else
    {
      this.hidemsgVerdeAlto();

      this._manageMessagesAfterImport();
    }


  }
  this.showCanNotShare = function () {

    this._manageMessagesAfterImport();

  }

  this._manageMessagesAfterImport = function () {

    if (this._getUsedProviders() == 0)
    {
      //non ho più provider da importare

      this.setmsgVerdeCentro(message_gettext('share_news_message_invited_single_contacts', itemtype));
      this.showmsgVerdeCentro();

    }
    else
    {
      //ho provider da importare
      if (last_provider_imported_name == "Altro") {
        this.setmsgCarrello(message_gettext('share_news_message_invited_single_contacts', itemtype));
        this.showmsgCarrello(true);
        this.showCarrello();
      } else {
        this.setmsgCarrello(message_gettext('share_news_message_invited_contacts', itemtype).replace("%%provider%%", last_provider_imported_label));
        this.showmsgCarrello(true);
        this.showCarrello();
      }
    }

    this.hideButton();
  }

  this._getUsedProviders = function () {
    tpi_a = $('.content-box-client-left .spunta').length - 1;
    tpi_b = $('.content-box-client-left .spunta-active').length;
    return (tpi_a - tpi_b);
  }

  this.manageMessageNewContactsImported = function () {
    this.setmsgVerdeCentro(message_gettext('share_news_message_invited_provider', itemtype));
    this.showmsgVerdeCentro();

    this.hideMsgWarningCentro();
  }
  this.manageMessageNoNewContactsImported = function () {
    this.setWarningCentro(share_news_message_invited_provider_no_new_contacts);
    this.showMsgWarningCentro();
  }

}