var pushItem;
var checkSharedNews;
var newsObj;
var share_response_mode = null;
var share_response_message = null;
var fb_data_to_share = null;
var fb_news_is_shared = null;
var contacts;
var bshare_first_import;
var modale_condividi;
var num_shared_news;
var itemtype;


message_gettext = function (message, itemtype) {
  var tmp;
  if (itemtype == T_VIDEO) {

    tmp = message.replace('share_news_message_', 'share_video_message_');
  } else {
    tmp = message;
  }
  return eval(tmp);
}

newsObj = function (news_id) {
  this.news_id = news_id;

}

function sharelink(news) {

  this.news_link = $(news);
  this.news_id = this.news_link.attr("data-news");
  this.itemtype = this.news_link.attr("data-type");

  this.news = new newsObj(this.news_id, this.itemtype);

  this.getNewsId = function () {
    return this.news_id;
  }
  this.getItemType = function () {
    return this.itemtype;
  }
  this.changeTextLinkToShared = function () {
    this.news_link.attr("class", "shared");
    this.news_link.find('.share-link-text').html(message_gettext('share_news_message_shared', itemtype));
  }
  this.changeTextLinkToNotShared = function () {
    this.news_link.html(message_gettext('share_news_message_share', itemtype));
  }

  this.shared = function () {
    this.changeTextLinkToShared();
  };
}

$(document).on("click", ".share", function (e) {
  if (flagLogged) {
    var link = this;
    var data = $(this).attr('data-news');
    itemtype = $(this).attr('data-type');
    if (device == 'Mobile')
    {
      window.location = redazione_prefix_url + '/' + loggedAuthor + '/' + share_author_prefix_slug + '/' + "?news_id=" + data + '&itemtype=' + itemtype + '&site=' + currentSite;
    }
    else
    {
      if ($(this).hasClass('opened'))
      {
        fbUnbindLogin();
        $(this).removeClass('opened').find('.freccia-share').hide();
        $('.to_share_' + data).css('z-index', '').find('.box-content-share').hide();
        $('#sfondo-overlay').hide();
        $('.freccia-share').hide();
      }
      else
      {
        $(this).addClass('opened').parent().find('.freccia-share').show();

        if ($(this).parent().parent().hasClass("box-action")) {
          $('.to_share_' + data).css('z-index', '1020').find('.box-content-share').css("top", $(this).parent().parent().parent().height() + 7);
        }

        //evitare il problema overlay con la skin
        $('.content-page-skin').css('z-index', '');
        $('#tbn_esplosa_pixel_skin_news_1x1, #div-gpt-ad-1430813024096-5').css('z-index', '-1');

        $('.to_share_' + data).css('z-index', '1020').find('.box-content-share').show();
        $('#sfondo-overlay').show();

        $.ajax({
          type: 'GET',
          url: '/app/condividi/',
          data: {
            news_id: data,
            itemtype: itemtype,
            site: currentSite
          },
          success: function (response) {
            if (response && response.response_data)
            {
              share_response_mode = response.response_code;

              obj_data = response.response_data;

              share_response_message = obj_data.message;

              //fb
              fb_data_to_share = obj_data.fb_data_to_share;
              fb_news_is_shared = obj_data.fb_is_shared;

              //contacts
              contacts = obj_data.contacts;

              num_shared_news = obj_data.num_shared_news;

              if (obj_data.get_modal_share) {
                var news_id = data;

                $(".box-content-share").find(".nws_" + news_id).html(obj_data.get_modal_share)

                        .find('.provider_logo_fb').attr('id', 'provider_fb_button_' + news_id)
                        .attr('data-news', news_id);

                $(".facebook-custom").find('.messages_fb').attr('id', 'fb_messages_' + news_id);
                $('#share_news_from_import').attr('data-news', news_id);
                $('#share_news_from_import').attr('data-type', itemtype);
                chebox_policy_share = $('.box-content-share').find('#chk-flag-policy-share');
              }

              if (obj_data.count_shared_news) {
                $('#' + news_id).siblings('.count-box').children('.count').html(obj_data.count_shared_news);
              }
            }

            share(link);
            fbBindPost(link);

          }
        });
      }

    }
  } else {
    show_modal($(this));
  }
});

$('#sfondo-overlay').click(function () {
  fbUnbindLogin();
  $('#sfondo-overlay').hide();
  $('.box-content-share').hide();
  $('.freccia-share').hide();
  $('li[class*="to_share_"]').removeAttr('style');
  $('.share').removeClass('opened');
  $('.content-box-provider').remove();
  //evitare il problema dell'overlay con la skin
  $('.content-page-skin').css('z-index', '3');
  $('#tbn_esplosa_pixel_skin_news_1x1, #div-gpt-ad-1430813024096-5').css('z-index', '0');

});

$(document).on("click", ".shared", function () {

});

function _fbPostedOnFacebookCallback(response, element) //depends on callback
{
  share_link = new sharelink(element);

  //update messages relativo alla news
  if (!response || response.error)
  {
    $('#provider_fb_button_' + share_link.getNewsId())
            .find('.button-blasting-fb')
            .find('.fb_status_board_message').html(share_news_message_share_fb_msg);
    $('.alert-danger-facebook').show();

  }
  else
  {
    //ok ho condiviso
    var news_provider_button_fb = $('#provider_fb_button_' + share_link.getNewsId());
    news_provider_button_fb.find('.button-blasting-fb').find('.fb_status_board_message').html(share_news_message_shared_fb_msg);
    news_provider_button_fb.find('i').addClass('spunta-active');


    fb_data_to_share = null;

    //salvo questo stato
    $.ajax({
      type: 'GET',
      url: '/app/condividi/',
      async: false,
      data: {action: 'fb_set_shared', id: share_link.getNewsId(), itemtype: itemtype}

    });
  }
}
//deve essere chiamata per preparare il bottone al click
function fbPostOnFacebook(button, _callbackLogin)
{
  link_to_share = new sharelink(button);
  news_provider_button_fb = $('#provider_fb_button_' + link_to_share.getNewsId());
  if(news_provider_button_fb.data('type') != 'facebook'){
    news_provider_button_fb.data('type','facebook');
    news_provider_button_fb.data('url',fb_data_to_share.link);
    news_provider_button_fb.bnSocialShare();
  }
}
//commentato il 21 feb 17: non lo faccio più tramite sdk ma aprendo direttamente popup di share (vedi fbPostOnFacebook)
//era chiamata nel momento del click sul bottone facebook
/*function fbPostOnFacebook_OLD(button, _callbackLogin)
{
  var link_to_share = new sharelink(button);

  //atterraggio dopo il post
  _callback = {
    scope: window,
    callback: _fbPostedOnFacebookCallback,
    arguments: [
      button
    ]
  };

  if (Blasting.FacebookSDK.isLoggedAndAllowed())
  {
   Blasting.FacebookSDK._executeShare(fb_data_to_share, _callback); 
  }
  else
  {
    //passando come parametro i dati da postare e callback, fa executeShare se ha
    //login e permessi abilitati
    Blasting.FacebookSDK._login(_callbackLogin, fb_data_to_share, _callback);
  }
}*/

//commentato il 21 feb 17
//non più usata chissà da quando
/*function fbTryAgain(button)
{
  //reset messages
  $('.alert-danger-facebook').hide();
  $('.alert-success-facebook').hide();

  fbPostOnFacebook(button)
}*/

//commentato il 21 feb 17
//non serve più, il bind vien fatto sempre
/*function _fbRebindIfNotLoggedIn(response, element)
{
  var link_to_share = new sharelink(element);

  if (!Blasting.FacebookSDK.isLoggedAndAllowed())
  {
    //non sono loggato
    $(document).one("click", "#provider_fb_button_" + link_to_share.getNewsId(), function () {

      login_callback = {
        scope: window,
        callback: _fbRebindIfNotLoggedIn,
        arguments: [
          this
        ]
      };

      fbPostOnFacebook(element, login_callback);
    });
  }
}*/

function fbBindPost(button)
{
  var link_to_share = new sharelink(button);

  if (typeof fb_news_is_shared !== 'undefined' && typeof fb_data_to_share != 'undefined') {

    if (fb_news_is_shared === true)
    {
      // già condivisa facebook
      var news_provider_button_fb = $('#provider_fb_button_' + link_to_share.getNewsId());
      news_provider_button_fb.find('.button-blasting-fb').find('.fb_status_board_message').html(share_news_message_shared_fb_msg);
      news_provider_button_fb.find('i').addClass('spunta-active');
    }
    else
    {
      fbPostOnFacebook(button);
      //commentato il 21 feb 17
      /*if (!Blasting.FacebookSDK.isLoggedAndAllowed())
      {
        $(document).off("click", "#provider_fb_button_" + link_to_share.getNewsId());
        //non sono loggato
        $(document).one("click", "#provider_fb_button_" + link_to_share.getNewsId(), function () {
          login_callback = {
            scope: window,
            callback: _fbRebindIfNotLoggedIn,
            arguments: [
              this
            ]
          };

          fbPostOnFacebook(button, login_callback);
        });
      }
      else
      {
        fbPostOnFacebook(button);
      }*/
    }

  } else {
    //errore
    fb_data_to_share = null;
    if (flagLogged)
    {
      $('.alert-danger-facebook').show();
    }
  }

}

function fbUnbindLogin()
{
  $(document).off("click", ".provider_logo_fb");
}

modaleShare = function () {
  this.titolo = $('#title-provider');
  this.msgVerdeAlto = $('#msgSuccessAlto');
  this.msgWarningAlto = $('#msgWarningAlto');
  this.msgWarningCentro = $('#msgWarning');
  this.msgCarrello = $('#msgimportedok');
  this.button = $('.content-box-form');

  this.titolo_seconda_condivisione = $('#title-provider-alreadyshared');

  this.textDefault = $('#textDefault');
  this.textAlreadyShared = $('#textAlreadyShared');

  this.showTitolo = function () {
    this.titolo.show();
  }

  this.hideTitolo = function () {
    this.titolo.hide();
  }
  this.setmsgVerdeAlto = function (message) {
    this.msgVerdeAlto.html(message);
  }
  this.showmsgVerdeAlto = function () {
    this.msgVerdeAlto.show();
    this.msgVerdeAlto.parent().show();
  }
  this.hidemsgVerdeAlto = function () {
    this.msgVerdeAlto.hide();
  }
  this.setmsgCarrello = function (message) {
    this.msgCarrello.html(message);
  }
  this.showmsgCarrello = function () {
    this.msgCarrello.show();
  }
  this.hidemsgCarrello = function () {
    this.msgCarrello.hide();
  }
  this.setWarningAlto = function (message) {
    this.msgWarningAlto.html(message);
  }
  this.showMsgWarningAlto = function () {
    this.msgWarningAlto.show();
    this.msgWarningAlto.parent().show();
  }
  this.hideMsgWarningAlto = function () {
    this.msgWarningAlto.hide();
    this.msgWarningAlto.parent().hide();
  }
  this.setWarningCentro = function (message) {
    this.msgWarningCentro.html(message);
  }
  this.showMsgWarningCentro = function () {
    this.msgWarningCentro.show();
    this.msgWarningCentro.parent().show();
  }
  this.hideMsgWarningCentro = function () {
    this.msgWarningCentro.hide();
    this.msgWarningCentro.parent().hide();
  }
  this.showButton = function () {
    this.button.addClass('content-box-form-active');
  }
  this.hideButton = function () {
    this.button.removeClass('content-box-form-active');
  }

  this.openModalCantShareNoContact = function () {
    this.showTitolo();

  }
  this.openModalCanNotShare = function (motivation) {
    this.titolo.hide();
    this.setWarningAlto(motivation);
    this.showMsgWarningAlto();
  }

  this.openModalCanNotShareNoPolicyForSomeone = function (motivation) {
    if (typeof motivation !== 'undefined') {
      this.openModalCanNotShare(motivation);
    } else {
      this.titolo.show();
    }

    if (contacts.contactsnopoliced.label.length <= 1) {
      this.setWarningCentro(message_gettext('share_news_message_complete_the_policy', itemtype));
    } else {
      this.setWarningCentro(message_gettext('share_news_message_complete_the_policy_plural_version', itemtype));
    }
    //this.setWarningCentro(share_news_message_complete_the_policy.replace('{providers_name}', contacts.contactsnopoliced.label.join(',')));
    this.showMsgWarningCentro();
    this.showButton();
  }
  this.openModalSharedSomeone = function () { //shared with someone, there are contacts no policed

    /* nascondo il titolo */
    this.titolo.hide();
    /* setto il messaggio della response */
    this.setmsgVerdeAlto(message_gettext('share_news_message_congratulation', itemtype));
    /* mostro l'allert */
    this.showmsgVerdeAlto();

    if (contacts.contactsnopoliced.label.length <= 1) {
      this.setWarningCentro(message_gettext('share_news_message_complete_the_policy', itemtype));
    } else {
      this.setWarningCentro(message_gettext('share_news_message_complete_the_policy_plural_version', itemtype));
    }
    //this.setWarningCentro(share_news_message_complete_the_policy.replace('{providers_name}', contacts.contactsnopoliced.label.join(',')));
    this.showMsgWarningCentro();
    this.showButton();
  }

  this.openModalSharedAllPoliced = function () {

    /* nascondo il titolo */
    this.titolo.hide();
    /* setto il messaggio della response */
    this.setmsgVerdeAlto(message_gettext('share_news_message_congratulation', itemtype));
    /* mostro l'allert */
    this.showmsgVerdeAlto();
  }

  this.switchTitleTextAfterFirstShare = function () {
    this.titolo.hide();
    this.titolo_seconda_condivisione.show();

    this.textDefault.hide();
    this.textAlreadyShared.show();
  }

  this.show = function () {
    $('.content-box-provider').show();
  }
}

function share(button) {
  var link_to_share = new sharelink(button);
  modale_condividi = new modaleShare();

  /* sono loggato ?*/
  if (flagLogged) {
    switch (share_response_mode)
    {
      case 'MODE_NOTSHARED_ZERO_CONTACTS':
        modale_condividi.openModalCantShareNoContact();
        bshare_first_import = true;
        break;
      case 'MODE_NOTSHARED_CONTACTS_NO_POLICY':
        modale_condividi.openModalCanNotShareNoPolicyForSomeone();
        break;
      case 'MODE_NOTSHARED_LIMIT_REACHED':

        modale_condividi.openModalCanNotShare(share_response_message);
        break;
      case 'MODE_NOTSHARED_LIMIT_REACHED_CONTACTS_NO_POLICY':

        modale_condividi.openModalCanNotShareNoPolicyForSomeone(share_response_message);
        break;
      case 'MODE_SHARED_ALL':
        pushItem(link_to_share.getNewsId(), link_to_share.getItemType());
        link_to_share.shared();
        /* apro la modale con l'alert al posto del titolo */
        modale_condividi.openModalSharedAllPoliced();
        break;
      case 'MODE_SHARED_SOMEONE':
        pushItem(link_to_share.getNewsId(), link_to_share.getItemType());
        link_to_share.shared();
        modale_condividi.openModalSharedSomeone();
      case 0:
        modale_condividi.openModalCanNotShare(share_response_message);
        break;
      default:
        break;
    }

    if (num_shared_news > 1) //dalla seconda condivisione
    {
      modale_condividi.switchTitleTextAfterFirstShare();
    } else if (num_shared_news == 1) {
      modale_condividi.showTitolo();
    }

    $('.content-box-provider').show();
  } else {
    $('.login-camera-pencil').click();
    $("#add_err").html(message_gettext('share_news_message_error_login', itemtype));
    bindLogin();
  }
}

function shared(button) {
  var link_to_share = new sharelink(button);
  link_to_share.changeTextLinkToShared();
}
function notshared(button) {

  var link_to_share = new sharelink(button);
  link_to_share.changeTextLinkToNotShared();
}

checkSharedNews = function (shared_news, shared_video) {
  $('.share').each(function (index) {
    var item_id = parseInt($(this).attr('data-news'));
    var type_of_item = parseInt($(this).attr('data-type'));
    /**
     * il tipo è incluso nel file delle lingue
     */
    switch (type_of_item) {
      case T_VIDEO:
        if ($.inArray(item_id, shared_video) != -1) {
          shared(this);
        }
        break;
      case T_NEWS:
        if ($.inArray(item_id, shared_news) != -1) {
          shared(this);
        }
        break;
      default:
        break;
    }
  }
  );
}

flushShareLink = function () {
  $('.shared').each(function (index) {
    var news_id = parseInt($(this).attr('data-news'));
    var type_of_item = parseInt($(this).attr('data-type'));
    $(this).attr('class', 'share ' + news_id).find('.share-link-text').html('!' + message_gettext('share_news_message_share_link', type_of_item));
  });
}

pushItem = function (item_id, itemtype) {
  /**
   * il tipo è incluso nel file delle lingue
   */
  switch (itemtype) {
    case T_VIDEO:
      sharedVideoFromUser.push(item_id);
      break;
    case T_NEWS:
      sharedNewsFromUser.push(item_id);
      break;
    default:

      break;
  }
}